name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS
        run: flutter build macos --release

      - name: Ad-hoc sign the app
        run: |
          # Sign all nested frameworks and dylibs first
          find "build/macos/Build/Products/Release/hemissync.app" -name "*.dylib" -o -name "*.framework" | while read item; do
            codesign --force --deep --sign - "$item" 2>/dev/null || true
          done
          # Sign the main app bundle
          codesign --force --deep --sign - "build/macos/Build/Products/Release/hemissync.app"
          # Verify signature
          codesign --verify --deep --strict "build/macos/Build/Products/Release/hemissync.app"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "HemiSync" \
            --volicon "macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_128.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "hemissync.app" 150 185 \
            --hide-extension "hemissync.app" \
            --app-drop-link 450 185 \
            --no-internet-enable \
            "HemiSync-macOS.dmg" \
            "build/macos/Build/Products/Release/hemissync.app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: HemiSync-macOS.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create Inno Setup script
        run: |
          @"
          [Setup]
          AppName=HemiSync
          AppVersion=1.0.5
          AppPublisher=HemiSync
          DefaultDirName={autopf}\HemiSync
          DefaultGroupName=HemiSync
          OutputDir=.
          OutputBaseFilename=HemiSync-Windows-Setup
          Compression=lzma
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

          [Icons]
          Name: "{group}\HemiSync"; Filename: "{app}\hemissync.exe"
          Name: "{commondesktop}\HemiSync"; Filename: "{app}\hemissync.exe"

          [Run]
          Filename: "{app}\hemissync.exe"; Description: "Launch HemiSync"; Flags: postinstall nowait
          "@ | Out-File -FilePath setup.iss -Encoding ASCII

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: HemiSync-Windows-Setup.exe

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk HemiSync-Android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: HemiSync-Android.apk

  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release

      - name: Package Web app
        run: |
          cd build
          zip -r HemiSync-Web.zip web
          mv HemiSync-Web.zip ${{ github.workspace }}/

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: HemiSync-Web.zip

  create-release:
    needs: [build-macos, build-windows, build-android, build-web]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: HemiSync ${{ steps.version.outputs.VERSION }}
          body: |
            ## HemiSync ${{ steps.version.outputs.VERSION }}

            Cross-platform binaural beats generator with independent left/right ear frequency control.

            ### Downloads

            | Platform | File | Instructions |
            |----------|------|--------------|
            | macOS | `HemiSync-macOS.dmg` | Open DMG, drag to Applications, see note below |
            | Windows | `HemiSync-Windows-Setup.exe` | Run installer, follow prompts |
            | Android | `HemiSync-Android.apk` | Enable "Unknown sources", install APK |
            | Web | `HemiSync-Web.zip` | Extract and host on any web server |

            ### macOS Installation Note
            Since the app is not notarized by Apple, macOS will block it. Use one of these methods:

            **Method 1 - Right-click Open (try this first):**
            1. Drag app to Applications folder
            2. **Right-click** (or Control+click) on hemissync.app
            3. Select **"Open"** from the menu
            4. Click **"Open"** in the dialog that appears

            **Method 2 - Terminal command (if Method 1 doesn't work):**
            ```
            xattr -cr /Applications/hemissync.app
            ```
            Then open the app normally.

            ### Features
            - Independent left/right ear frequency control (1 Hz - 25 kHz)
            - Multiple waveform types: Sine, Square, Triangle, Sawtooth
            - Real-time beat frequency display with brainwave category
            - Tap-to-edit frequency input for precise control
            - Session timer with auto-stop
            - Preset management
            - Background audio playback
            - Dark theme
          draft: false
          prerelease: false
          files: |
            artifacts/macos-build/HemiSync-macOS.dmg
            artifacts/windows-build/HemiSync-Windows-Setup.exe
            artifacts/android-build/HemiSync-Android.apk
            artifacts/web-build/HemiSync-Web.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-web:
    needs: [build-web]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href "/HemiSync/"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
